<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ORCA Output Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .controls {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            gap: 15px;
            align-items: center;
        }

        button {
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .status {
            flex: 1;
            text-align: right;
            color: #666;
            font-size: 14px;
        }

        .status.success {
            color: #28a745;
            font-weight: 600;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
            overflow-x: auto;
        }

        .tab {
            padding: 15px 25px;
            cursor: pointer;
            border: none;
            background: transparent;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
        }

        .tab:hover {
            background: #e9ecef;
            color: #333;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: white;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .card h3 {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .card .value {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }

        .card .label {
            font-size: 0.85em;
            opacity: 0.8;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden;
        }

        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
        }

        tbody tr:nth-child(even) {
            background: #f8f9fa;
        }

        tbody tr:hover {
            background: #e9ecef;
        }

        .section-title {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .info-box {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 20px;
            margin: 20px 0;
            border-radius: 4px;
        }

        .info-box h4 {
            margin-bottom: 10px;
            color: #667eea;
        }

        .progress {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            transition: width 0.5s;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .json-viewer {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.5;
            max-height: 600px;
            overflow-y: auto;
        }

        .molecular-structure {
            text-align: center;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 8px;
            margin: 20px 0;
        }

        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* File upload styles */
        .upload-area {
            border: 2px dashed #667eea;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9fa;
        }

        .upload-area:hover {
            border-color: #5568d3;
            background: #e7f1ff;
        }

        .upload-area.dragover {
            border-color: #5568d3;
            background: #e7f1ff;
            transform: scale(1.02);
        }

        input[type="file"] {
            display: none;
        }

        /* Visualization container */
        .viz-container {
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        #molecule-viewer {
            width: 100%;
            height: 500px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }

        /* Collapsible sections */
        .collapsible {
            cursor: pointer;
            padding: 15px;
            background: #f8f9fa;
            border: none;
            text-align: left;
            width: 100%;
            font-size: 16px;
            font-weight: 600;
            border-radius: 6px;
            margin-top: 10px;
            transition: all 0.3s;
        }

        .collapsible:hover {
            background: #e7f1ff;
        }

        .collapsible.active {
            background: #667eea;
            color: white;
        }

        .collapsible:after {
            content: '\002B';  /* + symbol */
            float: right;
            font-weight: bold;
        }

        .collapsible.active:after {
            content: "\2212";  /* - symbol */
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            background: white;
        }

        .collapsible-content.active {
            max-height: 2000px;
            padding: 15px;
        }

        /* Export buttons */
        .export-buttons {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }

        .btn-export {
            padding: 8px 16px;
            font-size: 12px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-export:hover {
            background: #218838;
        }
    </style>

    <!-- 3Dmol.js for 3D molecular visualization -->
    <script src="https://3Dmol.csb.pitt.edu/build/3Dmol-min.js"></script>

    <!-- Plotly.js for interactive charts -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>üß™ ORCA Output Viewer</h1>
            <p>Comprehensive Quantum Chemistry Data Visualization</p>
            <p style="margin-top: 10px; font-size: 0.9em;">34/57 sections parsed (60% coverage)</p>
        </header>

        <div class="controls">
            <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                <input type="file" id="fileInput" accept=".out,.txt" onchange="uploadFile(event)">
                <p>üì§ <strong>Upload ORCA Output File</strong></p>
                <p style="font-size: 12px; margin-top: 5px;">Drag & drop or click to browse (.out, .txt)</p>
            </div>
            <div style="display: flex; gap: 10px; flex: 1; align-items: center;">
                <button class="btn-primary" onclick="loadDefaultData()">üìÇ Load Example</button>
                <button class="btn-secondary" onclick="exportJSON()">üíæ Export JSON</button>
                <div class="status" id="status">Upload a file or load example data</div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('summary')">üìä Summary</button>
            <button class="tab" onclick="showTab('molecule')">üî¨ 3D Molecule</button>
            <button class="tab" onclick="showTab('plots')">üìà Interactive Plots</button>
            <button class="tab" onclick="showTab('geometry')">üìç Geometry</button>
            <button class="tab" onclick="showTab('energy')">‚ö° Energy</button>
            <button class="tab" onclick="showTab('orbitals')">üåÄ Orbitals</button>
            <button class="tab" onclick="showTab('vibrations')">üéµ Vibrations</button>
            <button class="tab" onclick="showTab('nmr')">üß≤ NMR</button>
            <button class="tab" onclick="showTab('population')">üë• Population</button>
            <button class="tab" onclick="showTab('raw')">üìÑ Raw JSON</button>
        </div>

        <!-- Summary Tab -->
        <div id="summary" class="tab-content active">
            <h2 class="section-title">Summary Overview</h2>
            <div id="summary-content">
                <p class="loading">Click "Load Data" to parse ORCA output file</p>
            </div>
        </div>

        <!-- 3D Molecule Tab -->
        <div id="molecule" class="tab-content">
            <h2 class="section-title">üî¨ 3D Molecular Structure</h2>
            <div class="viz-container">
                <div id="molecule-viewer"></div>
                <div style="margin-top: 15px;">
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px;">
                        <strong>Style:</strong>
                        <button class="btn-secondary" onclick="setMoleculeStyle('stick')">Stick</button>
                        <button class="btn-secondary" onclick="setMoleculeStyle('sphere')">Sphere</button>
                        <button class="btn-secondary" onclick="setMoleculeStyle('cartoon')">Ball & Stick</button>
                        <button class="btn-secondary" onclick="toggleLabels()">Labels</button>
                    </div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px;">
                        <strong>Color By:</strong>
                        <button class="btn-secondary" onclick="setChargeColoring('none')">Element</button>
                        <button class="btn-secondary" onclick="setChargeColoring('mulliken')">Mulliken Charge</button>
                        <button class="btn-secondary" onclick="setChargeColoring('loewdin')">Loewdin Charge</button>
                        <button class="btn-secondary" onclick="toggleDipole()">Dipole Vector</button>
                    </div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn-secondary" onclick="toggleBondOrders()">Show Bond Orders</button>
                        <button class="btn-export" onclick="exportMoleculeImage()">üì∑ Export PNG</button>
                    </div>
                    <div id="charge-legend" style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 6px; display: none;">
                        <strong>Charge Scale:</strong>
                        <div style="display: flex; align-items: center; gap: 10px; margin-top: 5px;">
                            <span style="color: red;">‚àí1.0 (negative)</span>
                            <div style="flex: 1; height: 20px; background: linear-gradient(to right, red, white, blue); border-radius: 4px;"></div>
                            <span style="color: blue;">+1.0 (positive)</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Interactive Plots Tab -->
        <div id="plots" class="tab-content">
            <h2 class="section-title">üìà Interactive Data Visualization</h2>

            <button class="collapsible" onclick="toggleCollapsible(this)">SCF Convergence Plot</button>
            <div class="collapsible-content">
                <div id="scf-plot" style="width: 100%; height: 400px;"></div>
                <div class="export-buttons">
                    <button class="btn-export" onclick="exportPlot('scf-plot', 'scf_convergence.png')">üì∑ PNG</button>
                    <button class="btn-export" onclick="exportPlot('scf-plot', 'scf_convergence.svg')">üìÑ SVG</button>
                </div>
            </div>

            <button class="collapsible" onclick="toggleCollapsible(this)">IR Spectrum</button>
            <div class="collapsible-content">
                <div id="ir-plot" style="width: 100%; height: 400px;"></div>
                <div class="export-buttons">
                    <button class="btn-export" onclick="exportPlot('ir-plot', 'ir_spectrum.png')">üì∑ PNG</button>
                    <button class="btn-export" onclick="exportPlot('ir-plot', 'ir_spectrum.svg')">üìÑ SVG</button>
                </div>
            </div>

            <button class="collapsible" onclick="toggleCollapsible(this)">Raman Spectrum</button>
            <div class="collapsible-content">
                <div id="raman-plot" style="width: 100%; height: 400px;"></div>
                <div class="export-buttons">
                    <button class="btn-export" onclick="exportPlot('raman-plot', 'raman_spectrum.png')">üì∑ PNG</button>
                    <button class="btn-export" onclick="exportPlot('raman-plot', 'raman_spectrum.svg')">üìÑ SVG</button>
                </div>
            </div>

            <button class="collapsible" onclick="toggleCollapsible(this)">Thermochemistry Energy Diagram</button>
            <div class="collapsible-content">
                <div id="thermo-plot" style="width: 100%; height: 400px;"></div>
                <div class="export-buttons">
                    <button class="btn-export" onclick="exportPlot('thermo-plot', 'thermochemistry.png')">üì∑ PNG</button>
                </div>
            </div>

            <button class="collapsible" onclick="toggleCollapsible(this)">Orbital Energy Diagram</button>
            <div class="collapsible-content">
                <div id="orbital-plot" style="width: 100%; height: 500px;"></div>
                <div class="export-buttons">
                    <button class="btn-export" onclick="exportPlot('orbital-plot', 'orbital_energies.png')">üì∑ PNG</button>
                </div>
            </div>

            <button class="collapsible" onclick="toggleCollapsible(this)">NMR Spectrum</button>
            <div class="collapsible-content">
                <div id="nmr-plot" style="width: 100%; height: 400px;"></div>
                <div class="export-buttons">
                    <button class="btn-export" onclick="exportPlot('nmr-plot', 'nmr_spectrum.png')">üì∑ PNG</button>
                </div>
            </div>
        </div>

        <!-- Geometry Tab -->
        <div id="geometry" class="tab-content">
            <h2 class="section-title">Molecular Geometry</h2>
            <div id="geometry-content">
                <p class="loading">No data loaded</p>
            </div>
        </div>

        <!-- Energy Tab -->
        <div id="energy" class="tab-content">
            <h2 class="section-title">Energy Data</h2>
            <div id="energy-content">
                <p class="loading">No data loaded</p>
            </div>
        </div>

        <!-- Orbitals Tab -->
        <div id="orbitals" class="tab-content">
            <h2 class="section-title">Molecular Orbitals</h2>
            <div id="orbitals-content">
                <p class="loading">No data loaded</p>
            </div>
        </div>

        <!-- Vibrations Tab -->
        <div id="vibrations" class="tab-content">
            <h2 class="section-title">Vibrational Analysis</h2>
            <div id="vibrations-content">
                <p class="loading">No data loaded</p>
            </div>
        </div>

        <!-- NMR Tab -->
        <div id="nmr" class="tab-content">
            <h2 class="section-title">NMR Spectroscopy</h2>
            <div id="nmr-content">
                <p class="loading">No data loaded</p>
            </div>
        </div>

        <!-- Population Tab -->
        <div id="population" class="tab-content">
            <h2 class="section-title">Population Analysis</h2>
            <div id="population-content">
                <p class="loading">No data loaded</p>
            </div>
        </div>

        <!-- Raw JSON Tab -->
        <div id="raw" class="tab-content">
            <h2 class="section-title">Raw JSON Data</h2>
            <div id="raw-content" class="json-viewer">
                <p>No data loaded</p>
            </div>
        </div>
    </div>

    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script>
        let data = null;
        let viewer3d = null;
        let showLabels = false;

        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            // Render 3D molecule when tab is shown
            if (tabName === 'molecule' && data) {
                setTimeout(() => render3DMolecule(), 100);
            }
        }

        function setStatus(message, success = false) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = success ? 'status success' : 'status';
        }

        // File upload handlers
        function uploadFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            handleFileUpload(file);
        }

        async function handleFileUpload(file) {
            setStatus(`Uploading ${file.name}...`);
            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();

                if (result.success) {
                    data = result.data;
                    setStatus(`‚úì Parsed ${file.name} successfully`, true);
                    renderAllTabs();
                } else {
                    setStatus(`‚úó Error: ${result.message}`, false);
                }
            } catch (error) {
                setStatus(`‚úó Upload failed: ${error.message}`, false);
            }
        }

        // Drag and drop
        const uploadArea = document.getElementById('uploadArea');
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) handleFileUpload(file);
        });

        async function loadDefaultData() {
            setStatus('Loading example data...');

            try {
                const response = await fetch('/api/parse', { method: 'POST' });
                const result = await response.json();

                if (result.success) {
                    data = result.data;
                    setStatus('‚úì Example data loaded successfully', true);
                    renderAllTabs();
                } else {
                    setStatus('‚úó Error: ' + result.message);
                }
            } catch (error) {
                setStatus('‚úó Error: ' + error.message);
            }
        }

        function renderAllTabs() {
            renderSummary();
            renderGeometry();
            renderEnergy();
            renderOrbitals();
            renderVibrations();
            renderNMR();
            renderPopulation();
            renderRawJSON();
            // Visualization tabs - rendered on demand when tab is shown
            renderAllPlots();
        }

        function renderSummary() {
            if (!data) return;

            const content = `
                <div class="summary-grid">
                    <div class="card">
                        <h3>Basis Set</h3>
                        <div class="value">${data.job_info.basis_set}</div>
                        <div class="label">${data.job_info.num_electrons} electrons</div>
                    </div>
                    <div class="card">
                        <h3>Final Energy</h3>
                        <div class="value">${data.final_energy ? data.final_energy.toFixed(6) : 'N/A'}</div>
                        <div class="label">Hartree</div>
                    </div>
                    <div class="card">
                        <h3>Atoms</h3>
                        <div class="value">${data.coordinates.length}</div>
                        <div class="label">Molecular system</div>
                    </div>
                    <div class="card">
                        <h3>Dipole Moment</h3>
                        <div class="value">${data.dipole_moment?.magnitude_debye?.toFixed(4) || 'N/A'}</div>
                        <div class="label">Debye</div>
                    </div>
                </div>

                <div class="info-box">
                    <h4>üìà Parser Coverage</h4>
                    <p>This file contains 34 parsed sections out of 57 total sections (60% coverage)</p>
                    <div class="progress">
                        <div class="progress-bar" style="width: 60%">60%</div>
                    </div>
                </div>

                <div class="info-box">
                    <h4>‚ÑπÔ∏è Computation Details</h4>
                    <p><strong>Basis Functions:</strong> ${data.basis_set_info?.num_basis_functions || 'N/A'}</p>
                    <p><strong>DFT Grid Points:</strong> ${data.dft_grid_info?.total_grid_points?.toLocaleString() || 'N/A'}</p>
                    <p><strong>Total Runtime:</strong> ${data.timing_data?.total_run_time ? (data.timing_data.total_run_time / 60).toFixed(1) + ' minutes' : 'N/A'}</p>
                </div>
            `;

            document.getElementById('summary-content').innerHTML = content;
        }

        function renderGeometry() {
            if (!data || !data.coordinates) return;

            let html = '<table><thead><tr><th>Atom</th><th>Element</th><th>X (√Ö)</th><th>Y (√Ö)</th><th>Z (√Ö)</th></tr></thead><tbody>';
            
            data.coordinates.forEach((coord, i) => {
                html += `<tr>
                    <td>${i}</td>
                    <td><strong>${coord[0] || 'N/A'}</strong></td>
                    <td>${typeof coord[1] === 'number' ? coord[1].toFixed(6) : 'N/A'}</td>
                    <td>${typeof coord[2] === 'number' ? coord[2].toFixed(6) : 'N/A'}</td>
                    <td>${typeof coord[3] === 'number' ? coord[3].toFixed(6) : 'N/A'}</td>
                </tr>`;
            });

            html += '</tbody></table>';
            document.getElementById('geometry-content').innerHTML = html;
        }

        function renderEnergy() {
            if (!data) return;

            const thermo = data.thermochemistry || {};
            const html = `
                <div class="info-box">
                    <h4>Single Point Energy</h4>
                    <p><strong>Final Energy:</strong> ${data.final_energy ? data.final_energy.toFixed(6) : 'N/A'} Eh</p>
                </div>

                <div class="info-box">
                    <h4>Thermochemistry (298.15 K)</h4>
                    <p><strong>Gibbs Free Energy:</strong> ${thermo.gibbs_free_energy ? thermo.gibbs_free_energy.toFixed(6) : 'N/A'} Eh</p>
                    <p><strong>Enthalpy:</strong> ${thermo.total_enthalpy ? thermo.total_enthalpy.toFixed(6) : 'N/A'} Eh</p>
                    <p><strong>Zero Point Energy:</strong> ${thermo.zero_point_energy ? thermo.zero_point_energy.toFixed(6) : 'N/A'} Eh</p>
                </div>

                <div class="info-box">
                    <h4>SCF Convergence</h4>
                    <p><strong>Iterations:</strong> ${data.scf_energies?.length || 'N/A'}</p>
                    <p><strong>Final Energy:</strong> ${data.scf_energies?.length ? data.scf_energies[data.scf_energies.length - 1].toFixed(6) + ' Eh' : 'N/A'}</p>
                </div>
            `;

            document.getElementById('energy-content').innerHTML = html;
        }

        function renderOrbitals() {
            if (!data || !data.orbital_energies) return;

            const orbitals = data.orbital_energies.slice(0, 50); // Show first 50

            let html = '<table><thead><tr><th>MO</th><th>Occupation</th><th>Energy (eV)</th><th>Energy (Eh)</th></tr></thead><tbody>';
            
            orbitals.forEach(orb => {
                const highlight = orb.occupation > 0.5 && orb.occupation < 2.0 ? 'style="background: #ffffcc;"' : '';
                html += `<tr ${highlight}>
                    <td>${orb.index || 'N/A'}</td>
                    <td>${orb.occupation?.toFixed(4) || 'N/A'}</td>
                    <td>${orb.energy_ev?.toFixed(4) || 'N/A'}</td>
                    <td>${orb.energy_eh?.toFixed(6) || 'N/A'}</td>
                </tr>`;
            });

            html += '</tbody></table>';
            html += `<p style="margin-top: 20px; color: #666;">Showing first 50 of ${data.orbital_energies.length} molecular orbitals</p>`;
            
            document.getElementById('orbitals-content').innerHTML = html;
        }

        function renderVibrations() {
            if (!data || !data.frequencies) return;

            let html = '<table><thead><tr><th>Mode</th><th>Frequency (cm‚Åª¬π)</th><th>Raman Activity</th></tr></thead><tbody>';
            
            data.frequencies.forEach((freq, i) => {
                const raman = data.raman_spectrum?.[i]?.activity?.toFixed(2) || 'N/A';
                html += `<tr>
                    <td>${i + 1}</td>
                    <td>${typeof freq === 'number' ? freq.toFixed(2) : 'N/A'}</td>
                    <td>${raman}</td>
                </tr>`;
            });

            html += '</tbody></table>';
            document.getElementById('vibrations-content').innerHTML = html;
        }

        function renderNMR() {
            if (!data || !data.nmr_data) return;

            const shifts = data.nmr_data.chemical_shifts;
            
            let html = '<table><thead><tr><th>Nucleus</th><th>Element</th><th>Isotropic (ppm)</th><th>Anisotropy (ppm)</th></tr></thead><tbody>';
            
            shifts.forEach(shift => {
                html += `<tr>
                    <td>${shift.nucleus || 'N/A'}</td>
                    <td><strong>${shift.element || 'N/A'}</strong></td>
                    <td>${shift.isotropic?.toFixed(2) || 'N/A'}</td>
                    <td>${shift.anisotropy?.toFixed(2) || 'N/A'}</td>
                </tr>`;
            });

            html += '</tbody></table>';
            document.getElementById('nmr-content').innerHTML = html;
        }

        function renderPopulation() {
            if (!data) return;

            let html = '<div class="info-box"><h4>Mulliken Charges</h4><table><thead><tr><th>Atom</th><th>Element</th><th>Charge</th></tr></thead><tbody>';
            
            Object.entries(data.mulliken_charges).forEach(([atom, info]) => {
                html += `<tr>
                    <td>${atom}</td>
                    <td><strong>${info.element || 'N/A'}</strong></td>
                    <td>${info.charge?.toFixed(4) || 'N/A'}</td>
                </tr>`;
            });

            html += '</tbody></table></div>';

            html += '<div class="info-box"><h4>Bond Orders</h4>';
            html += `<p><strong>Mayer Bond Orders:</strong> ${data.mayer_bond_orders.length} bonds</p>`;
            html += `<p><strong>Loewdin Bond Orders:</strong> ${data.loewdin_bond_orders.length} bonds</p>`;
            html += '</div>';

            document.getElementById('population-content').innerHTML = html;
        }

        function renderRawJSON() {
            if (!data) return;
            document.getElementById('raw-content').innerHTML = '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
        }

        function exportJSON() {
            if (!data) {
                alert('No data loaded. Please load data first.');
                return;
            }

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'orca_output_parsed.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function refreshData() {
            location.reload();
        }

        // ===== 3D MOLECULAR VISUALIZATION =====
        function render3DMolecule() {
            if (!data || !data.coordinates) return;

            const container = document.getElementById('molecule-viewer');
            container.innerHTML = ''; // Clear previous viewer

            viewer3d = $3Dmol.createViewer(container, {
                backgroundColor: 'white'
            });

            // Convert coordinates to XYZ format
            let xyzData = `${data.coordinates.length}\nORCA Molecule\n`;
            data.coordinates.forEach(coord => {
                const [element, x, y, z] = coord;
                xyzData += `${element}  ${x}  ${y}  ${z}\n`;
            });

            viewer3d.addModel(xyzData, 'xyz');
            viewer3d.setStyle({}, {stick: {radius: 0.15}, sphere: {scale: 0.3}});
            viewer3d.zoomTo();
            viewer3d.render();
        }

        function setMoleculeStyle(style) {
            if (!viewer3d) return;
            viewer3d.setStyle({}, {});

            if (style === 'stick') {
                viewer3d.setStyle({}, {stick: {radius: 0.15}});
            } else if (style === 'sphere') {
                viewer3d.setStyle({}, {sphere: {scale: 0.5}});
            } else if (style === 'cartoon') {
                viewer3d.setStyle({}, {stick: {radius: 0.15}, sphere: {scale: 0.3}});
            }

            viewer3d.render();
        }

        function toggleLabels() {
            if (!viewer3d || !data) return;
            showLabels = !showLabels;

            viewer3d.removeAllLabels();
            if (showLabels) {
                data.coordinates.forEach((coord, i) => {
                    viewer3d.addLabel(coord[0], {
                        position: {x: coord[1], y: coord[2], z: coord[3]},
                        backgroundColor: 'white',
                        fontColor: 'black',
                        fontSize: 12
                    });
                });
            }
            viewer3d.render();
        }

        function exportMoleculeImage() {
            if (!viewer3d) return;
            const imgData = viewer3d.pngURI();
            const a = document.createElement('a');
            a.href = imgData;
            a.download = 'molecule_3d.png';
            a.click();
        }

        // ===== PLOTLY VISUALIZATIONS =====
        function renderAllPlots() {
            if (!data) return;
            renderSCFPlot();
            renderIRPlot();
            renderRamanPlot();
            renderThermoPlot();
            renderOrbitalPlot();
            renderNMRPlot();
        }

        function renderSCFPlot() {
            if (!data || !data.scf_energies || data.scf_energies.length === 0) return;

            const trace = {
                x: Array.from({length: data.scf_energies.length}, (_, i) => i + 1),
                y: data.scf_energies,
                mode: 'lines+markers',
                name: 'SCF Energy',
                line: {color: '#667eea', width: 2},
                marker: {size: 6}
            };

            const layout = {
                title: 'SCF Convergence',
                xaxis: {title: 'Iteration'},
                yaxis: {title: 'Energy (Eh)'},
                hovermode: 'closest'
            };

            Plotly.newPlot('scf-plot', [trace], layout, {responsive: true});
        }

        function renderIRPlot() {
            if (!data || !data.ir_spectrum || data.ir_spectrum.length === 0) return;

            const frequencies = data.ir_spectrum.map(d => d.frequency);
            const intensities = data.ir_spectrum.map(d => d.intensity);

            const trace = {
                x: frequencies,
                y: intensities,
                type: 'bar',
                marker: {color: '#28a745'},
                name: 'IR Intensity'
            };

            const layout = {
                title: 'IR Spectrum',
                xaxis: {title: 'Frequency (cm‚Åª¬π)'},
                yaxis: {title: 'Intensity (km/mol)'},
                hovermode: 'closest'
            };

            Plotly.newPlot('ir-plot', [trace], layout, {responsive: true});
        }

        function renderRamanPlot() {
            if (!data || !data.raman_spectrum || data.raman_spectrum.length === 0) return;

            const frequencies = data.raman_spectrum.map(d => d.frequency);
            const activities = data.raman_spectrum.map(d => d.activity);

            const trace = {
                x: frequencies,
                y: activities,
                type: 'bar',
                marker: {color: '#dc3545'},
                name: 'Raman Activity'
            };

            const layout = {
                title: 'Raman Spectrum',
                xaxis: {title: 'Frequency (cm‚Åª¬π)'},
                yaxis: {title: 'Raman Activity'},
                hovermode: 'closest'
            };

            Plotly.newPlot('raman-plot', [trace], layout, {responsive: true});
        }

        function renderThermoPlot() {
            if (!data || !data.thermochemistry) return;

            const thermo = data.thermochemistry;
            const labels = ['Electronic', 'ZPE', 'Thermal', 'Enthalpy', 'Gibbs Free'];
            const values = [
                data.final_energy || 0,
                thermo.zero_point_energy || 0,
                thermo.total_enthalpy || 0,
                thermo.total_enthalpy || 0,
                thermo.gibbs_free_energy || 0
            ];

            const trace = {
                x: labels,
                y: values,
                type: 'bar',
                marker: {color: ['#667eea', '#764ba2', '#28a745', '#ffc107', '#dc3545']}
            };

            const layout = {
                title: 'Thermochemistry Energy Diagram',
                yaxis: {title: 'Energy (Eh)'},
                hovermode: 'closest'
            };

            Plotly.newPlot('thermo-plot', [trace], layout, {responsive: true});
        }

        function renderOrbitalPlot() {
            if (!data || !data.orbital_energies || data.orbital_energies.length === 0) return;

            // Show orbitals around HOMO-LUMO (e.g., HOMO-10 to LUMO+10)
            const orbitals = data.orbital_energies.slice(Math.max(0, data.orbital_energies.length / 2 - 20), data.orbital_energies.length / 2 + 20);

            const occupied = orbitals.filter(o => o.occupation > 0.5);
            const virtual = orbitals.filter(o => o.occupation <= 0.5);

            const trace1 = {
                x: occupied.map(o => o.index),
                y: occupied.map(o => o.energy_ev),
                mode: 'markers',
                name: 'Occupied',
                marker: {size: 8, color: '#28a745'}
            };

            const trace2 = {
                x: virtual.map(o => o.index),
                y: virtual.map(o => o.energy_ev),
                mode: 'markers',
                name: 'Virtual',
                marker: {size: 8, color: '#dc3545'}
            };

            const layout = {
                title: 'Molecular Orbital Energy Diagram',
                xaxis: {title: 'MO Index'},
                yaxis: {title: 'Energy (eV)'},
                hovermode: 'closest'
            };

            Plotly.newPlot('orbital-plot', [trace1, trace2], layout, {responsive: true});
        }

        function renderNMRPlot() {
            if (!data || !data.nmr_data || !data.nmr_data.chemical_shifts || data.nmr_data.chemical_shifts.length === 0) return;

            const shifts = data.nmr_data.chemical_shifts;
            const x = shifts.map(s => s.isotropic);
            const y = Array(shifts.length).fill(1); // Height of peaks
            const labels = shifts.map(s => `${s.element}${s.nucleus}`);

            const trace = {
                x: x,
                y: y,
                mode: 'markers',
                marker: {size: 12, color: '#667eea'},
                text: labels,
                hoverinfo: 'text+x'
            };

            const layout = {
                title: 'NMR Chemical Shifts',
                xaxis: {title: 'Chemical Shift (ppm)', autorange: 'reversed'},
                yaxis: {title: 'Intensity', showticklabels: false},
                hovermode: 'closest'
            };

            Plotly.newPlot('nmr-plot', [trace], layout, {responsive: true});
        }

        // ===== COLLAPSIBLE SECTIONS =====
        function toggleCollapsible(element) {
            element.classList.toggle('active');
            const content = element.nextElementSibling;
            content.classList.toggle('active');
        }

        // ===== EXPORT FUNCTIONS =====
        function exportPlot(plotId, filename) {
            Plotly.downloadImage(plotId, {
                format: filename.endsWith('.svg') ? 'svg' : 'png',
                filename: filename.replace(/\.(png|svg)$/, ''),
                width: 1200,
                height: 800
            });
        }
    </script>
</body>
</html>
